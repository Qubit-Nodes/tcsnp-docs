**TCSNP (Transmittable Common Server Network Protocol)**  
*Полная спецификация с учётом оптимизаций и усиления защиты*

---

## 1. Введение

TCSNP — протокол нового поколения, объединяющий:

- **Анонимизацию метаданных** через многоуровневую Onion-маршрутизацию, адаптивный фиктивный трафик и одноразовые временные идентификаторы.  
- **Децентрализацию без блокчейна**, основанную на Onion-DHT с динамической репликацией, шифрованием XOR и «слепыми» репутационными метриками.  
- **Защиту от анализа трафика**: постоянный размер пакетов, псевдонимизация узлов, искусственный джиттер и разделение каналов управления и данных.  
- **P2P-архитектуру**: любая нода — одновременно и клиент, и сервер.  
- **Гибридную репутацию**: автоматический учёт успешных обменов и голосование пользователей с ограничением влияния.  

---

## 2. Архитектура

### 2.1. Компоненты

- **Гварды**: стабильная доступность > 95 %, репутация > 90.  
- **Ретрансляторы**: промежуточные узлы Onion-маршрута.  
- **Сервис-ноды**: хранение и выдача данных, с кешированием «горячих» участков DHT.  
- **Exit-ноды**: прокси-интернет через анонимный мост (Exit-Bridge).  
- **Обычные ноды**: прямой обмен между собой без выхода в интернет, для локальных P2P-сессий.

### 2.2. Onion-DHT (три слоя)

1. **Слой ключей**: публичные ключи гвардов и ретрансляторов.  
2. **Слой узлов**: анонимные хеши сервис-нод и обычных нод без гео-привязки, с динамическим балансом нагрузки.  
3. **Слой метаданных**: шардированные записи, XOR-обфускация с солью, кэширование популярных запросов и proximity-маршрутизация.  

### 2.3. Архитектурные схемы

#### 2.3.1. Анонимный Интернет-мост и быстрый путь

![](blob:https://imgur.com/8b765fca-ae08-446f-b5d3-494211b6c7d3)

#### 2.3.2. Прямая коммуникация обычных нод

![](blob:https://imgur.com/b337061f-70dc-45b6-bc9c-7881c4e50b8c)

---

## 3. Присоединение ноды

### 3.1. Анонимная инициализация

1. Генерация одноразовой пары Ed25519 → `temp_id` (HMAC-BLAKE3).
2. Onion-Discovery: три гварда снимают шифровальные слои.
3. Регистрация через DHT-запрос с `temp_id`, зашифрованными метаданными и маршрутными токенами.

### 3.2. Stake + PoW + Web-of-Trust и Sybil-защита

* **Динамический Stake-депозит**:

  ```text
  Base_stake * (1 + 0.2 * (100 - Rep_avg))
  ```

  — минимальный депозит зависит от средней репутации и % свободных слотов; при массовой регистрации с одной подсети ставка растёт автоматически.
* **Proof-of-Identity (опционально)**: для гвардов и Exit-нод с ZK-доказательством владения верифицируемой идентичностью (SSL-сертификат, децентрализованный DID); не влияет на анонимность обычных нод.
* **Web-of-Trust поведенческий анализ**: вес рекомендации = `min(репутация рекомендующего, 30)`; паутины из > 5 взаимосвязанных нод с аномалиями автоматически инвалидаются.
* **Sybil-Score**: учёт геораспределения, uptime и «эффекта новизны» (новые ноды ограничены 50 соединениями/час).

---

## 4. Onion-маршрутизация

### 4.1. Формирование цепочек

* **Стандарт**: Клиент → 2 гварда → 2 ретранслятора → сервис-нода.
* **FastCircuit**: два параллельных пути с агрегированием ответов и выбором быстрейшего.
* Переключение при задержках > RTT\_threshold.

### 4.2. Шифрование и маскировка трафика

* **Фиксированный размер пакета** — 1024 B; три режима адаптивных пакетов:

  * Standard (1024 B)
  * Real-Time (512 B)
  * Bulk (2048 B)
    Выбор по QoS-меткам приложений; для VoIP/игр отключается фиктивный трафик при RTT > 150 мс.
* **Искусственный джиттер** с приоритезацией:

  ```python
  def calculate_jitter(packet_type):
      if packet_type == CONTROL: return random(0, 30ms)
      if packet_type == REALTIME: return random(0, 50ms)
      return random(0, 100ms)
  ```
* **Adaptive dummy traffic**: снижение объёма под нагрузку, пороговые интервалы генерации ложных пакетов.
* **Multipath QUIC** для FastCircuit: фрагменты по двум путям, сборка через XOR.

---

## 5. Анонимный обмен данными

### 5.1. Garlic-Messaging

* Несколько вложенных сообщений в одном пакете.
* Отдельный `session_id` для каждой сессии с ротацией каждые N минут.

### 5.2. Слепые запросы к DHT

* Bloom-фильтры маскируют ключевые запросы, возвращая расширенный набор записей.
* Диапазонные префиксы (`EU:00…EU:FF`) вместо точных хэшей; пост-фильтрация на клиенте.

---

## 6. Репутационная система

### 6.1. Слепые токены и аудит

* При успешной передаче получатель выдаёт Chaumian-токен.
* **Mix-сеть** разрывает связь «токен ↔ репутация».
* Мини-блокчейн в слое 3 DHT с snapshot-ами и pruning устаревших токенов.

### 6.2. Взвешенное голосование и антиколлюзия

* Вес голоса ≤ 2× от репутации.
* Алгоритм LCA для обнаружения взаимных голосований и автоматического снижения веса.

### 6.3. Деградация и самовосстановление

* Репутация падает при отказе > 5 % запросов за час или под-RTT критерием.
* Репутация < 30 → приостановка на 24 ч с возможностью апелляции через web-of-trust.

---

## 7. Безопасность и анонимность

* **Ротация цепочек** каждые 10 мин, сброс ключей при простое > 5 мин.
* **Quantum-safe шифрование**:

  * Handshake — NTRUEncrypt (квантово-безопасный).
  * Трафик — XChaCha20-Poly1305 (256-битный ключ).
* **Стратификация нод**: гварды и Exit-ноды выполняют NTRU-операции; обычные ноды используют пред-распределённые сессионные ключи.
* **Аппаратное ускорение**: AVX-512 для вычислений NTRU, кэширование параметров повторных сессий.
* **Proof-of-Bandwidth**: лёгкие Hashcash-задания при всплесках активности, лимиты соединений по репутации.
* **Rolling-Key механизм**: ежедневное обновление NTRU-ключей через DHT-слой с 3× репликацией.
* **Резервные протоколы**: при отказе Onion-маршрута переход к AlternativeRoute (VPN через Noise).

---

## 8. Оптимизации производительности

* **ECDH-Precompute**: предвычисленные ключи с активными гвардами.
* **Adaptive Congestion Control**: динамическая настройка окна передачи и фиктивных пакетов по RTT и потерям.
* **Multiplexed Streams**: несколько логических каналов в одном туннеле.
* **Локальные микросети**: протокол Noise для прямого обмена в подсети, снижая нагрузку DHT.
* **Latency-карты в DHT**: ноды публикуют историю задержек; маршрутизатор строит путь через `min(RTT_percentile_90)`.

---

## 9. Анонимный Интернет-мост (Exit-Bridge)

### 9.1. Архитектура и балансировка

* Exit-ноды (`exit=true`) проксируют трафик через FastBridge Overlay на базе QUIC.
* Load-balancer выбирает три моста с репутацией > 85, перестраивает цепочку каждые 5 мин.
* **Dual encryption**: Onion + TLS к целевому ресурсу.
* **Auction-based bandwidth** и Latency-Aware Routing по SLA.
* **Fast/Slow path**: для VoIP и стриминга приоритетный маршрут без фиктивного трафика.

---

## 10. Фазовый rollout и совместимость

1. **Версионирование DHT**: новые поля игнорируются старыми нодами, сохраняется backward-compatibility.
2. **Поэтапное внедрение**:

   * **Этап 1**: Proof-of-Bandwidth, ECDH-Precompute, базовый Onion-маршрутизатор.
   * **Этап 2**: Stake-депозиты, adaptive dummy traffic, web-of-trust и Sybil-Score.
   * **Этап 3**: Exit-Bridge, Auction-based балансировка, квантово-безопасные алгоритмы.
3. **Анонимная телеметрия**: lightweight-агенты собирают метрики отказов и задержек, отправляют в DHT-oracle без привязки к ноде.
