**TCSNP (Transmittable Common Server Network Protocol)**  

---

### **1. Введение**  
TCSNP — протокол нового поколения, объединяющий децентрализацию, криптографическую анонимность и устойчивость к цензуре. Ключевые улучшения:  
- **Полная анонимизация**: Сокрытие метаданных через Onion-маршрутизацию и временные идентификаторы.  
- **Отказ от блокчейна**: Использование DHT с динамической репликацией и слепыми репутационными метриками.  
- **Сопротивление трафик-анализу**: Обфускация пакетов и псевдонимизация узлов.  
- **P2P-архитектура**: Все ноды являются одновременно серверами и клиентами, обеспечивая полную децентрализацию и равноправие узлов.  
- **Двойная репутационная система**: Репутация на основе подключений и репутация, регулируемая пользователями.  

---

### **2. Архитектура**  
#### **2.1. Компоненты системы**  
- **Ноды-участники**:  
  - **Гварды**: Ноды с uptime > 95%, репутацией > 90 (аналоги Tor Guard).  
  - **Ретрансляторы**: Промежуточные узлы для Onion-маршрутизации.  
  - **Сервис-ноды**: Хранят данные и обрабатывают запросы (анонимные аналоги серверов).  
- **Onion-DHT**: Модифицированная DHT с разделением на три слоя:  
  - **Слой 1**: Хранит публичные ключи гвардов и ретрансляторов.  
  - **Слой 2**: Анонимные хеши сервис-нод (без привязки к геолокации).  
  - **Слой 3**: Шардированные метаданные с обфускацией записей (кодирование XOR + соль).  

---

### **3. Присоединение ноды**  
#### **3.1. Анонимная инициализация**  
1. **Генерация временного идентификатора**:  
   - Каждая нода создает одноразовую пару ключей (Ed25519) при каждом перезапуске.  
   - Публичный ключ хешируется через HMAC-BLAKE3 с секретной солью → `temp_id`.  

2. **Onion-Discovery**:  
   - Запросы рассылаются через цепочку из 3 случайных гвардов (Onion-шифрование).  
   - Каждый гвард удаляет свой слой шифрования и перенаправляет пакет.  

3. **Регистрация в DHT**:  
   - Нода отправляет в Onion-DHT подписанный запрос с `temp_id` и зашифрованными метаданными:  
     ```json
     {
       "temp_id": "a1b2c3...",  
       "enc_metadata": "AES-256(GCM){'protocols': ['TCP', 'UDP'], 'region': 'XX'}",
       "onion_route": ["Guard1_pubkey", "Guard2_pubkey", "Relay_pubkey"]  
     }
     ```  
   - Репутация вычисляется через слепую подпись: нода доказывает свою надежность, не раскрывая историю активности.  

---

### **4. Onion-маршрутизация**  
#### **4.1. Формирование цепочки**  
1. **Выбор узлов**:  
   - Клиент случайно выбирает 3 гварда из DHT (слой 1) и 2 ретранслятора (слой 2).  
   - Цепочка: `Клиент → Guard1 → Relay1 → Guard2 → Relay2 → Сервис-нода`.  

2. **Многослойное шифрование**:  
   - Каждый пакет шифруется в обратном порядке (от сервиса к клиенту):  
     ```python
     # Пример для 3 хопов:
     packet = Encrypt(Relay2_pubkey, 
               Encrypt(Guard2_pubkey, 
                 Encrypt(Relay1_pubkey, 
                   Encrypt(Guard1_pubkey, payload))))
     ```  
   - Каждый узел расшифровывает свой слой и узнает следующий хоп.  

#### **4.2. Защита метаданных**  
- **Фиксированный размер пакетов**: Все пакеты дополняются до 1024 байт случайными данными.  
- **Ложный трафик**: Ноды периодически отправляют пустые зашифрованные пакеты для маскировки реальной активности.  

---

### **5. Анонимный обмен данными**  
#### **5.1. Протокол Garlic Messaging**  
- **Вложенные сообщения**: В один пакет упаковываются несколько сообщений для разных получателей (аналогично I2P).  
- **Сессионные псевдонимы**: Для каждой транзакции генерируется уникальный идентификатор (`session_id`), не связанный с `temp_id`.  

#### **5.2. Слепые запросы к DHT**  
- **Поиск без раскрытия намерений**:  
  - Клиент отправляет в DHT хеш запроса, замаскированный через bloom filter.  
  - Ноды возвращают все записи, соответствующие фильтру, даже если они не точно соответствуют запросу.  
- **Шифрование запросов**: Параметры поиска (например, геолокация) заменяются на диапазоны (`EU:*` → `[EU:00...EU:FF]`).  

---

### **6. Репутационная система**  
#### **6.1. Слепые репутационные токены**  
- **Механизм начисления**:  
  - При успешной передаче данных получатель подписывает слепой токен (по схеме Chaumian).  
  - Нода обменивает токены на репутационные баллы через микширующий сервис, не раскрывая источник.  
- **Деградация репутации**:  
  - Автоматическое снижение баллов при отклонении > 5% запросов за час.  
  - Ноды с репутацией < 30 исключаются из DHT на 24 часа.  

#### **6.2. Пользовательская репутация**  
- **Оценка нод пользователями**:  
  - Пользователи могут оценивать ноды на основе качества предоставляемых услуг.  
  - Оценки хранятся в зашифрованном виде и учитываются при расчете общей репутации ноды.  
- **Механизм голосования**:  
  - Пользователи могут голосовать за или против ноды, используя криптографически подписанные токены.  
  - Голоса учитываются с весами, зависящими от репутации голосующих пользователей.  

#### **6.3. Доказательство работы (PoW)**  
- Для предотвращения сибил-атак:  
  - Новые ноды должны решить криптографическую задачу (Hashcash-style) перед регистрацией в DHT.  
  - Сложность задачи динамически регулируется на основе нагрузки сети.  

---

### **7. Безопасность и анонимность**  
#### **7.1. Защита от корреляции**  
- **Вращение цепочек**: Onion-маршруты перестраиваются каждые 10 минут.  
- **Разделение потоков**: Данные и управляющие команды передаются через разные цепочки.  

#### **7.2. Анти-экфилиация**  
- **Сброс сессий**: Все ключи (сессионные, идентификаторы) удаляются при бездействии > 5 мин.  
- **Квантово-безопасные алгоритмы**: Резервное шифрование на основе NTRUEncrypt для критичных данных.  

---

### **8. Оптимизации**  
- **Локальные микросети**: Ноды в одной подсети (например, Wi-Fi mesh) обмениваются данными напрямую через Noise Protocol Framework.  
- **Предсказуемая задержка**: Искусственное добавление джиттера (0–100 мс) для маскировки реального местоположения.  
